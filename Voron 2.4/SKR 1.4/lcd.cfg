#####################################################################
# 	Display
#####################################################################
[display]
##	mini12864 LCD Display
lcd_type: uc1701
cs_pin: z:P1.18
a0_pin: z:P1.19
encoder_pins: ^z:P3.26,^z:P3.25
click_pin: ^!z:P0.28
contrast: 63
display_group: __voron_display

[neopixel fysetc_mini12864]
##	To control Neopixel RGB in mini12864 display
pin: z:P1.21
chain_count: 3
initial_RED: 1
initial_GREEN: 0
initial_BLUE: 0.0
color_order: RGB

##	Set RGB values on boot up for each Neopixel. 
##	Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode setdisplayneopixel]
initial_duration: 1
gcode:
        SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
        SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
        SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3

#####################################################################
# 	Glyph definition
#####################################################################
[display_glyph chamber]
data:
  ................
  ****************
  *....*....*....*
  *....*....*....*
  *....******....*
  *..............*
  *..............*
  *.....****.....*
  *.***.*..*.***.*
  *.....****.....*
  *......**......*
  *..............*
  *.************.*
  *...*......*...*
  ****************
  ................
  
[display_glyph voron]
data:
  ......***.......
  ....*******.....
  ...*********....
  .*************..
  *****..***..***.
  ****..***..****.
  ***..***..*****.
  **..***..******.
  ******..***..**.
  *****..***..***.
  ****..***..****.
  ***..***..*****.
  .*************..
  ...*********....
  ....*******.....
  ......***.......  
 
[display_glyph raspberry]
data:
  ................
  ....****.****...
  ...*....*....*..
  ...**...*...**..
  ....*..***..*...
  ....****.****...
  ...*...***...*..
  ...**...*...**..
  ..*.*...*...*.*.
  ..*.*..***..*.*.
  ..*****...*****.
  ...*..*...*..*..
  ...*..**.**..*..
  ....*.*****.*...
  .....**...**....
  .......***......

[display_glyph TMC]
data:
  ................
  ................
  ...**..**..**...
  ...**..**..**...
  ..************..
  .*............*.
  .*............*.
  .*............*.
  .*............*.
  .*............*.
  .*............*.
  ..************..
  ...**..**..**...
  ...**..**..**...
  ................
  ................

#####################################################################
# 	Display Data definition
#####################################################################
[display_template _vheater_temperature]
param_heater_name: "extruder"
text:
  {% if param_heater_name in printer %}
    {% set heater = printer[param_heater_name] %}
    # Show glyph
    {% if param_heater_name == "heater_bed" %}
      {% if heater.target %}
        {% set frame = (printer.toolhead.estimated_print_time|int % 2) + 1 %}
        ~bed_heat{frame}~
      {% else %}
        ~bed~
      {% endif %}
    {% else %}
      ~extruder~
    {% endif %}
    # Show temperature
    { "%3.0f" % (heater.temperature,) }
    # Optionally show target
    {% if heater.target and (heater.temperature - heater.target)|abs > 2 %}
      ~right_arrow~
      { "%0.0f" % (heater.target,) }
    {% endif %}
    ~degrees~
  {% endif %}

[display_data __voron_display extruder]
position: 0, 0
text: { render("_vheater_temperature", param_heater_name="extruder") }

[display_data __voron_display fan]
position: 2, 0
text:
  {% if 'fan' in printer %}
    {% set speed = printer.fan.speed %}
    {% if speed %}
      {% set frame = (printer.toolhead.estimated_print_time|int % 2) + 1 %}
      ~fan{frame}~
    {% else %}
      ~fan1~
    {% endif %}
    { "{:>4.0%}".format(speed) }
  {% endif %}

[display_data __voron_display bed]
position: 1, 0
text: { render("_vheater_temperature", param_heater_name="heater_bed") }

[display_data __voron_display progress_text]
position: 2, 10
text:
  {% set progress = printer.display_status.progress %}
  { "{:^6.0%}".format(progress) }
  
[display_data __voron_display progress_text2]
position: 2, 10
text:
  {% set progress = printer.display_status.progress %}
  { draw_progress_bar(2, 10, 6, progress) }

#[display_data __voron_display printing_time]
#position: 3, 0
#text:
#  {% set ptime = printer.idle_timeout.printing_time %}
#  { "%02d:%02d" % (ptime // (60 * 60), (ptime // 60) % 60) }

#[display_data __voron_display TMC]
#position: 2, 10
#text:
#    {% set TMC5160 = printer['temperature_sensor TMC'] %}
#	~TMC5160~
#	 { "%3.0f" % (TMC.temperature,) }
#	~degrees~

[display_data __voron_display chamber]
position: 0, 10
text:
  {% set chamber = printer['temperature_fan chamber'] %}
	~chamber~
	{ "%3.0f" % (chamber.temperature,) }
	~degrees~

[display_data __voron_display rpi]
position: 1, 10
text:
    {% set raspberry = printer['temperature_sensor raspberry_pi'] %}
	~raspberry~
	 { "%3.0f" % (raspberry.temperature,) }
	~degrees~


[display_data __voron_display print_status]
position: 3, 0
text: 
  {% if printer.display_status.message %}
    { printer.display_status.message }
  {% elif printer.idle_timeout.printing_time|int != 0 %}
    {% set pos = printer.toolhead.position %}
    { "X%-4.0fY%-4.0fZ%-5.2f" % (pos.x, pos.y, pos.z) }
  {% else %}
    { "V2.1598 " }
	~voron~
  {% endif %}

#####################################################################
# 	LCD Macro
#####################################################################
[gcode_macro _LCD_KNOB]
description: Helper: Set LCD Knob color
variable_color: 'RED'
variable_restore: 'RED'
variable_index: 2
variable_blink: 0
variable_sync: 1
gcode:
  # set default parameter value
  {% set time = params.BLINK|default(0)|float %}
  SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=sync VALUE={params.SYNC|default(1)}
  {% set var_color=printer["gcode_macro _LCD_KNOB"].color %}
  {% set var_restore=printer["gcode_macro _LCD_KNOB"].restore %}
  SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=blink VALUE={time}
  UPDATE_DELAYED_GCODE ID=_BLINK_DELAY DURATION={time}
  SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=restore VALUE='"{var_color}"'
  {% if params.COLOR == 'GREEN'%}
    SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=color VALUE='"GREEN"'
    SET_LED LED=fysetc_mini12864 RED=0 GREEN=1.0 BLUE=0 INDEX=2 TRANSMIT=0 SYNC={sync} 
    SET_LED LED=fysetc_mini12864 RED=0 GREEN=1.0 BLUE=0 INDEX=3 TRANSMIT=1 SYNC={sync}
  {% elif params.COLOR == 'RED'%}
    SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=color VALUE='"RED"'
    SET_LED LED=fysetc_mini12864 RED=1.0 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0 SYNC={sync}
    SET_LED LED=fysetc_mini12864 RED=1.0 GREEN=0 BLUE=0 INDEX=3 TRANSMIT=1 SYNC={sync}
  {% elif params.COLOR == 'BLUE'%}
    SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=color VALUE='"BLUE"'
    SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=1.0 INDEX=2 TRANSMIT=0 SYNC={sync}
    SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=1.0 INDEX=3 TRANSMIT=1 SYNC={sync}
  {% else %}
    {% if var_restore == 'GREEN'%}
      SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=color VALUE='"GREEN"'
      SET_LED LED=fysetc_mini12864 RED=0 GREEN=1.0 BLUE=0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=0 GREEN=1.0 BLUE=0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% elif var_restore == 'RED'%}
      SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=color VALUE='"RED"'
      SET_LED LED=fysetc_mini12864 RED=1.0 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=1.0 GREEN=0 BLUE=0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% elif var_restore == 'BLUE'%}
      SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=color VALUE='"BLUE"'
      SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=1.0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=1.0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% endif %}
  {% endif %}
  
[delayed_gcode _BLINK_DELAY]
gcode:
  {% set var_color=printer["gcode_macro _LCD_KNOB"].color %}
  {% set sync=printer["gcode_macro _LCD_KNOB"].sync %}
  {% if printer["gcode_macro _LCD_KNOB"].index|int == 2 %}
    SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=index VALUE=3
    {% if var_color == 'GREEN'%}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=1.0 BLUE=0.0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=0.0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% elif var_color == 'RED'%}
      SET_LED LED=fysetc_mini12864 RED=1.0 GREEN=0.0 BLUE=0.0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=0.0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% elif var_color == 'BLUE'%}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=1.0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=0.0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% endif %}
  {% else %}
    SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=index VALUE=2
    {% if var_color == 'GREEN'%}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=0.0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=1.0 BLUE=0.0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% elif var_color == 'RED'%}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=0.0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=1.0 GREEN=0.0 BLUE=0.0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% elif var_color == 'BLUE'%}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=0.0 INDEX=2 TRANSMIT=0 SYNC={sync}
      SET_LED LED=fysetc_mini12864 RED=0.0 GREEN=0.0 BLUE=1.0 INDEX=3 TRANSMIT=1 SYNC={sync}
    {% endif %}
  {% endif %}
  UPDATE_DELAYED_GCODE ID=_BLINK_DELAY DURATION={printer["gcode_macro _LCD_KNOB"].blink|float}

[delayed_gcode _LCD_INIT_OFF]
gcode:
  SET_GCODE_VARIABLE MACRO=DISPLAY VARIABLE=state VALUE='"off"'
  SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=1 SYNC=0

[gcode_macro DISPLAY]
description: Toggle Display backlight
variable_state: 'on'
gcode:
  {% if printer["gcode_macro DISPLAY"].state == 'on' %}
    _DISPLAY_OFF
  {% else %}
    _DISPLAY_ON
  {% endif %}
    
[gcode_macro _DISPLAY_STATE]
description: Helper: Print display backlight state
gcode:
  {action_respond_info("LCD display %s" % (printer["gcode_macro DISPLAY"].state))}

[gcode_macro _DISPLAY_OFF]
description: Helper: Display backlight off
gcode:
  SET_GCODE_VARIABLE MACRO=DISPLAY VARIABLE=state VALUE='"off"'
  SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
  SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
  SET_LED LED=fysetc_mini12864 RED=0 GREEN=0 BLUE=0 TRANSMIT=1
  SET_LED LED=unten RED=0 GREEN=0 BLUE=0 
  _DISPLAY_STATE

[gcode_macro _DISPLAY_ON]
description: Helper: Display backlight on
gcode:
  SET_GCODE_VARIABLE MACRO=DISPLAY VARIABLE=state VALUE='"on"'
  SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0
  SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
  SET_LED LED=fysetc_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3
  SET_LED LED=unten RED=0.3 GREEN=0 BLUE=0 TRANSMIT=1
  _DISPLAY_STATE

[gcode_macro _PRINT_AR]
description: Helper: Action response 
gcode:
  #####  set defaults  #####
  {% set show_lcd = params.SHOW_LCD|default('false') %}
  {% set show_console = params.SHOW_CONSOLE|default('true') %}
  {% if show_lcd == 'true' %}
    M117 {'%s' % (params.T|string)}
  {% endif %}
  {% if show_console == 'true' %}
    {action_respond_info("%s" % (params.T|string))}
  {% endif %}

## Clear display output after Duration in seconds 
##  Use: UPDATE_DELAYED_GCODE ID=_CLEAR_DISPLAY DURATION=1
[delayed_gcode _CLEAR_DISPLAY]
gcode:
  M117